pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps()
    }

    environment {
        APP_DIR = "full-stack_chatApp"

        CHAT_APP_BACKEND_IMAGE_NAME  = "chatapp-backend"
        CHAT_APP_FRONTEND_IMAGE_NAME = "chatapp-frontend"
    }

    stages {

        stage("Checkout Source Code") {
            steps {
                echo "üì• Checking out source code..."
                cleanWs()
                git branch: 'main',
                    url: 'https://github.com/PSBHURE/Chat-app.git',
                    credentialsId: 'github-credentials'
            }
        }

        stage("Read & Increment Version") {
            steps {
                dir("${APP_DIR}") {
                    script {
                        def versionFile = "version.txt"

                        if (!fileExists(versionFile)) {
                            echo "‚ö†Ô∏è version.txt not found. Creating default version 1.0.0"
                            writeFile file: versionFile, text: "1.0.0"
                        }

                        def version = readFile(versionFile).trim()
                        echo "üî¢ Current Version: ${version}"

                        def (major, minor, patch) = version.tokenize('.')
                        patch = patch.toInteger() + 1
                        env.NEW_VERSION = "${major}.${minor}.${patch}"

                        echo "üìà New Version: ${env.NEW_VERSION}"

                        writeFile file: versionFile, text: env.NEW_VERSION

                        withCredentials([usernamePassword(
                            credentialsId: 'github-credentials',
                            usernameVariable: 'GIT_USERNAME',
                            passwordVariable: 'GIT_PASSWORD'
                        )]) {
                            sh """
                                git config user.name "PSBHURE"
                                git config user.email "bhurepratik2@gmail.com"
                                git add ${versionFile}
                                git commit -m "üîñ Update version to ${env.NEW_VERSION}" || echo "No changes to commit"
                                git remote set-url origin https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/PSBHURE/Chat-app.git
                                git push origin main
                            """
                        }
                    }
                }
            }
        }

        stage("Build Docker Images") {
            steps {
                dir("${APP_DIR}") {
                    echo "üê≥ Building Docker images..."

                    dir("backend") {
                        sh """
                            docker build \
                            -t ${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION} \
                            -t ${CHAT_APP_BACKEND_IMAGE_NAME}:latest .
                        """
                    }

                    dir("frontend") {
                        sh """
                            docker build \
                            -t ${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION} \
                            -t ${CHAT_APP_FRONTEND_IMAGE_NAME}:latest .
                        """
                    }
                }
            }
        }

        stage("Push Images to DockerHub") {
            steps {
                echo "üì¶ Pushing Docker images to DockerHub..."
                withCredentials([usernamePassword(
                    credentialsId: "DockerHubCred",
                    usernameVariable: "DOCKER_USER",
                    passwordVariable: "DOCKER_PASS"
                )]) {
                    sh """
                        docker login -u $DOCKER_USER -p $DOCKER_PASS

                        docker tag ${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION} $DOCKER_USER/${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION}
                        docker tag ${CHAT_APP_BACKEND_IMAGE_NAME}:latest $DOCKER_USER/${CHAT_APP_BACKEND_IMAGE_NAME}:latest

                        docker tag ${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION} $DOCKER_USER/${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION}
                        docker tag ${CHAT_APP_FRONTEND_IMAGE_NAME}:latest $DOCKER_USER/${CHAT_APP_FRONTEND_IMAGE_NAME}:latest

                        docker push $DOCKER_USER/${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION}
                        docker push $DOCKER_USER/${CHAT_APP_BACKEND_IMAGE_NAME}:latest

                        docker push $DOCKER_USER/${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION}
                        docker push $DOCKER_USER/${CHAT_APP_FRONTEND_IMAGE_NAME}:latest
                    """
                }
            }
        }

        stage("Success") {
            steps {
                echo "‚úÖ CI/CD Pipeline completed successfully!"
                echo "üöÄ Released Version: ${env.NEW_VERSION}"
            }
        }
    }

    post {
        failure {
            echo "‚ùå Pipeline failed. Please check logs above."
        }
    }
}

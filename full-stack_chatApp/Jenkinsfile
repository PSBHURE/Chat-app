pipeline {
    agent any

    environment {
        CHAT_APP_BACKEND_IMAGE_NAME = "chatapp-backend"
        CHAT_APP_FRONTEND_IMAGE_NAME = "chatapp-frontend"
    }

    stages {
        stage("Clone Repository") {
            steps {
                echo "üì• Cloning the repository..."
                cleanWs()
                git branch: 'main', url: 'https://github.com/PSBHURE/Chat-app.git'
            }
        }

        stage("Read & Increment Version") {
            steps {
                    script {
                        def versionFile = 'version.txt'
                        def version = readFile(versionFile).trim()
                        echo "üî¢ Current Version: ${version}"

                        // Increment patch version
                        def (major, minor, patch) = version.tokenize('.')
                        patch = patch.toInteger() + 1
                        env.NEW_VERSION = "${major}.${minor}.${patch}"
                        echo "üìà New Version: ${env.NEW_VERSION}"

                        // Save new version to file
                        writeFile file: versionFile, text: env.NEW_VERSION

                        // Commit and push version.txt using credentials
                        withCredentials([usernamePassword(
                            credentialsId: 'github-credentials',
                            usernameVariable: 'GIT_USERNAME',
                            passwordVariable: 'GIT_PASSWORD'
                        )]) {
                            sh """
                                git config user.name "PSBHURE"
                                git config user.email "bhurepratik2@gmail.com"
                                git add ${versionFile}
                                git commit -m "üîñ Update version to ${env.NEW_VERSION}" || echo "No changes to commit"
                                git remote set-url origin https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/PSBHURE/Chat-app.git
                                git push origin main
                            """
                        }
                    }
            }
        }

        stage("Build Docker Image") {
            steps {
                echo "üê≥ Building Docker image..."
                dir("chat-app-backend") {
                    sh "docker build -t ${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION} -t ${CHAT_APP_BACKEND_IMAGE_NAME}:latest ."
                }
                dir("chat-app-frontend") {
                    sh "docker build -t ${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION} -t ${CHAT_APP_FRONTEND_IMAGE_NAME}:latest ."
                }
            }
        }

        stage("Push to DockerHub") {
            steps {
                echo "üì¶ Pushing image to DockerHub..."
                script {
                    withCredentials([usernamePassword(
                        credentialsId: "DockerHubCred",
                        usernameVariable: "DockerHubUser",
                        passwordVariable: "DockerHubPass"
                    )]) {
                        sh """
                            docker login -u $DockerHubUser -p $DockerHubPass

                            docker tag ${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION} $DockerHubUser/${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION}
                            docker tag ${CHAT_APP_BACKEND_IMAGE_NAME}:latest $DockerHubUser/${CHAT_APP_BACKEND_IMAGE_NAME}:latest

                            docker tag ${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION} $DockerHubUser/${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION}
                            docker tag ${CHAT_APP_FRONTEND_IMAGE_NAME}:latest $DockerHubUser/${CHAT_APP_FRONTEND_IMAGE_NAME}:latest

                            docker push $DockerHubUser/${CHAT_APP_BACKEND_IMAGE_NAME}:${env.NEW_VERSION}
                            docker push $DockerHubUser/${CHAT_APP_BACKEND_IMAGE_NAME}:latest

                            docker push $DockerHubUser/${CHAT_APP_FRONTEND_IMAGE_NAME}:${env.NEW_VERSION}
                            docker push $DockerHubUser/${CHAT_APP_FRONTEND_IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }

        stage("Success Feedback") {
            steps {
                echo "‚úÖ Jenkins pipeline completed successfully! Version: ${env.NEW_VERSION}"
            }
        }
    }
}
